{% extends 'template.html' %}
{% block breadcrumb %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
    <li class="breadcrumb-item text-sm">
      <a class="opacity-5 text-dark" href="javascript:;">Pages</a>
    </li>
    <li class="breadcrumb-item text-sm text-dark active" aria-current="page">
      History
    </li>
  </ol>
  <h2 class="font-weight-bolder mb-0">History</h2>
</nav>
{% endblock %}

{% block title %}History{% endblock %}

{% block page1 %}active{% endblock %}

{% block content %}
<style>
body, .main-content, .container-fluid {
  background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%) !important;
}
.card.bg-gradient-primary {
  background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%) !important;
  color: #fff !important;
}
.btn-modern-download {
  background: linear-gradient(90deg, #34d399 0%, #10b981 100%);
  color: #fff !important;
  border: none;
  border-radius: 2rem;
  font-weight: 600;
  padding: 0.5rem 1.5rem;
  box-shadow: 0 2px 8px rgba(52,211,153,0.08);
  transition: background 0.2s, box-shadow 0.2s;
}
.btn-modern-download:hover {
  background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
  box-shadow: 0 4px 16px rgba(52,211,153,0.16);
}
.btn-modern-delete {
  background: linear-gradient(90deg, #f87171 0%, #ef4444 100%);
  color: #fff !important;
  border: none;
  border-radius: 2rem;
  font-weight: 600;
  padding: 0.5rem 1.5rem;
  box-shadow: 0 2px 8px rgba(239,68,68,0.08);
  transition: background 0.2s, box-shadow 0.2s;
}
.btn-modern-delete:hover {
  background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
  box-shadow: 0 4px 16px rgba(239,68,68,0.16);
}
</style>
<div class="container-fluid">
  <!-- Welcome Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0 p-4 text-center bg-gradient-primary text-white">
        <h2 class="mb-2">Welcome to Car-nalytics!</h2>
        <p class="mb-3">Easily upload car images, apply AI-powered analysis, and view your results in a beautiful dashboard.</p>
        <div class="d-flex justify-content-center gap-3">
          <a href="{{ url_for('uploadfile') }}" class="btn btn-light btn-lg px-4"><i class="fa fa-upload me-2"></i>Upload Image</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Recent Activity / Uploads Placeholder -->
  <div class="row mt-4" id="results">
    <div class="col-12 mb-3 d-flex flex-wrap align-items-center justify-content-between">
      <div class="d-flex gap-2 align-items-center">
        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Search by filename..." style="max-width:200px;">
        <select id="brandFilter" class="form-select form-select-sm" style="max-width:180px;">
          <option value="">All Brands</option>
          {% for brand in brands %}
            <option value="{{ brand }}">{{ brand }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="col-12">
      <h4 class="mb-3">Recent Uploads</h4>
      <div class="row" id="gallery">
        {% if files %}
          {% for i in files %}
            {% set parts = i.split('/') %}
            {% set timestamp = parts[1] %}
            {% set original_filename = parts[-1] %}
            <div class="col-xl-3 col-md-6 mb-4 gallery-item" data-filename="{{ original_filename|lower }}" data-brand="{{ timestamp }}">
              <div class="card card-blog card-plain h-100">
                <div class="position-relative">
                  <a href="#" class="d-block shadow-xl border-radius-xl"
                     data-bs-toggle="modal"
                     data-bs-target="#detailsModal"
                     data-img="{{ url_for('static', filename='uploads/' + timestamp + '/sementic.jpg') }}"
                     data-filename="{{ original_filename }}"
                     data-download="{{ url_for('static', filename='uploads/' + timestamp + '/original.jpg') }}"
                     onclick="showDetailsModal(this)">
                    <img src="{{ url_for('static', filename='uploads/' + timestamp + '/sementic.jpg') }}"
                         alt="img-blur-shadow"
                         class="img-fluid shadow border-radius-xl" style="height:200px;object-fit:cover;" />
                  </a>
                </div>
                <div class="card-body px-1 pb-0 d-inline-block text-truncate mt-auto">
                  <p class="text-gradient text-dark mb-2 text-sm">Original Filename</p>
                  <a href="#" data-bs-toggle="modal" data-bs-target="#detailsModal"
                     data-img="{{ url_for('static', filename='uploads/' + timestamp + '/sementic.jpg') }}"
                     data-filename="{{ original_filename }}"
                     data-download="{{ url_for('static', filename='uploads/' + timestamp + '/original.jpg') }}"
                     onclick="showDetailsModal(this)">
                    <h5>{{ original_filename }}</h5>
                  </a>
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <a href="{{ url_for('static', filename='uploads/' + timestamp + '/original.jpg') }}" download class="btn btn-modern-download btn-sm mb-3"><i class="fa fa-download me-1"></i>Download</a>
                    <button class="btn btn-modern-delete btn-sm mb-3" onclick="confirmDelete('{{ timestamp }}')"><i class="fa fa-trash me-1"></i>Delete</button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="col-12 text-center text-muted py-5">
            <i class="fa fa-folder-open fa-3x mb-3"></i>
            <p>No uploads yet. Click <b>Upload Image</b> to get started!</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">Image Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="modalImage" src="" alt="Preview" class="img-fluid rounded shadow mb-3" style="max-height:350px;" />
        <p class="mb-1"><b>Original Filename:</b> <span id="modalFilename"></span></p>
        <a id="modalDownload" href="#" class="btn btn-modern-download mt-2" download><i class="fa fa-download me-2"></i>Download</a>
        <button class="btn btn-modern-delete mt-2 ms-2" id="modalDelete" onclick="deleteFromModal()" data-timestamp=""><i class="fa fa-trash me-2"></i>Delete</button>
      </div>
    </div>
  </div>
</div>
<script>
function showDetailsModal(element) {
  var modalImage = document.getElementById('modalImage');
  var modalFilename = document.getElementById('modalFilename');
  var modalDownload = document.getElementById('modalDownload');
  var modalDelete = document.getElementById('modalDelete');
  if (modalImage) modalImage.src = element.getAttribute('data-img');
  if (modalFilename) modalFilename.innerText = element.getAttribute('data-filename');
  if (modalDownload) modalDownload.href = element.getAttribute('data-download');
  // Set the timestamp for the modal delete button
  var timestamp = '';
  var imgPath = element.getAttribute('data-img');
  var match = imgPath.match(/uploads\/(.*?)\//);
  if (match && match[1]) {
    timestamp = match[1];
  }
  if (modalDelete) modalDelete.setAttribute('data-timestamp', timestamp);
}

function deleteFromModal() {
  var modalDelete = document.getElementById('modalDelete');
  if (!modalDelete) return;
  var timestamp = modalDelete.getAttribute('data-timestamp');
  if (timestamp) {
    confirmDelete(timestamp);
  }
}

function confirmDelete(timestamp) {
  if (confirm('Are you sure you want to delete this upload?')) {
    fetch(`/delete_upload/${timestamp}`, {method: 'POST'})
      .then(res => res.json())
      .then(data => { if(data.status==='success'){ location.reload(); } else { alert('Delete failed'); } });
  }
}

// Simple client-side search/filter
document.addEventListener('DOMContentLoaded', function() {
  var searchInput = document.getElementById('searchInput');
  var brandFilter = document.getElementById('brandFilter');
  var galleryItems = document.querySelectorAll('.gallery-item');
  function filterGallery() {
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const brand = brandFilter ? brandFilter.value : '';
    galleryItems.forEach(item => {
      const filename = item.getAttribute('data-filename');
      const itemBrand = item.getAttribute('data-brand');
      const matchesSearch = !search || filename.includes(search);
      const matchesBrand = !brand || itemBrand === brand;
      item.style.display = (matchesSearch && matchesBrand) ? '' : 'none';
    });
  }
  if (searchInput) searchInput.addEventListener('input', filterGallery);
  if (brandFilter) brandFilter.addEventListener('change', filterGallery);
});
</script>
{% endblock %}
 